import shutil
import os
import time
import traceback
from dotenv import load_dotenv

# ğŸ“¦ ë‚´ë¶€ ëª¨ë“ˆ
from chatbot_v3 import load_or_build_vectorstore

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
# 0. í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ (OPENAI_API_KEY ë“±)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
load_dotenv()

JSON_PATH   = "FINAL_key_cat.json"    # í•„ìš” ì‹œ ë‹¤ë¥¸ JSONìœ¼ë¡œ êµì²´
BASE_DIR    = "./chroma_policies"     # ê¸°ë³¸ ë²¡í„° DB í´ë”
OPENAI_KEY  = os.getenv("OPENAI_API_KEY", "")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
# 1. ì¬ë¹Œë“œ í•¨ìˆ˜ (readonly ì˜¤ë¥˜ ìë™ ì²˜ë¦¬)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
def rebuild_vectorstore(persist_dir: str) -> None:
    """ì§€ì • í´ë”ë¥¼ ì‚­ì œí•œ ë’¤ ë²¡í„°ìŠ¤í† ì–´ë¥¼ ë‹¤ì‹œ ë¹Œë“œí•œë‹¤.
    'readonly database' ì˜¤ë¥˜ ë°œìƒ ì‹œ íƒ€ì„ìŠ¤íƒ¬í”„ ë””ë ‰í„°ë¦¬ë¡œ ìë™ ì¬ì‹œë„."""
    # â‘  ê¸°ì¡´ í´ë” ì œê±°
    shutil.rmtree(persist_dir, ignore_errors=True)

    try:
        # â‘¡ ê¸°ë³¸ ê²½ë¡œë¡œ ë¹Œë“œ
        load_or_build_vectorstore(
            json_path=JSON_PATH,
            persist_dir=persist_dir,
            api_key=OPENAI_KEY,
        )
        print(f"âœ…  ë²¡í„°ìŠ¤í† ì–´ê°€ {persist_dir} ì— ì •ìƒ ë¹Œë“œë˜ì—ˆìŠµë‹ˆë‹¤!")
    except Exception as e:
        if "readonly database" in str(e).lower():
            # â‘¢ DuckDB ì ê¸ˆìœ¼ë¡œ ì“°ê¸° ì‹¤íŒ¨ â†’ ìƒˆ ê²½ë¡œë¡œ ì¬ì‹œë„
            alt_dir = f"{persist_dir}_{int(time.time())}"
            print(f"[!] readonly DB ì˜¤ë¥˜. ìƒˆ í´ë” {alt_dir} ë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤.")
            load_or_build_vectorstore(
                json_path=JSON_PATH,
                persist_dir=alt_dir,
                api_key=OPENAI_KEY,
            )
            print(f"âœ…  ë²¡í„°ìŠ¤í† ì–´ê°€ {alt_dir} ì— ì •ìƒ ë¹Œë“œë˜ì—ˆìŠµë‹ˆë‹¤!")
        else:
            # â‘£ ì˜ˆê¸°ì¹˜ ì•Šì€ ì˜¤ë¥˜ëŠ” ìŠ¤íƒ ì¶”ì  ì¶œë ¥ í›„ ì¬ë°œìƒ
            traceback.print_exc()
            raise

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
# 2. ì‹¤í–‰ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
if __name__ == "__main__":
    rebuild_vectorstore(BASE_DIR)